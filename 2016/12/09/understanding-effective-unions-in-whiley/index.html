<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Understanding Effective Unions in Whiley"><meta name=twitter:title content="Understanding Effective Unions in Whiley"><meta property="og:url" content="https://whileydave.com/2016/12/09/understanding-effective-unions-in-whiley/"><title>David J. Pearce
(Understanding Effective Unions in Whiley)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Understanding Effective Unions in Whiley</h1><div class=post-date>Friday, December
9th,
2016</div><hr><p>The concept of <em>effective union types</em> in Whiley exposes some interesting features worth considering.  In particular, they result in a separation between the <em>readable</em> and <em>writeable</em> view of a type.  But, we&rsquo;re getting ahead of ourselves!  Let&rsquo;s start with what exactly effective unions are&mldr;</p><h3 id=effective-unions>Effective Unions</h3><p>An effective union is a union type which has some commonality which can be exploited.  Here&rsquo;s a simple example to illustrate:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-whiley data-lang=whiley><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Rectangle <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> x, <span style=color:#078;font-weight:700>int</span> y, <span style=color:#078;font-weight:700>int</span> width, <span style=color:#078;font-weight:700>int</span> height }
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Circle <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> x, <span style=color:#078;font-weight:700>int</span> y, <span style=color:#078;font-weight:700>int</span> radius }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// A shape is either a rectangle or a circle
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>type</span> Shape <span style=color:#069;font-weight:700>is</span> Rectangle <span style=color:#555>|</span> Circle
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Move the center point by a given translation
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>function</span> translate(Shape s, <span style=color:#078;font-weight:700>int</span> dx, <span style=color:#078;font-weight:700>int</span> dy) <span style=color:#555>-&amp;</span>gt; (Shape r)<span style=color:#555>:</span>
</span></span><span style=display:flex><span>    s.x <span style=color:#555>=</span> s.x <span style=color:#555>+</span> dx
</span></span><span style=display:flex><span>    s.y <span style=color:#555>=</span> s.y <span style=color:#555>+</span> dy
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> s
</span></span></code></pre></div><p>This little function is responsible for moving the position of a given <code>Shape</code>. Since both <code>Rectangle</code> and <code>Circle</code> have the fields <code>x</code> and <code>y</code>, we can access them when given just a <code>Shape</code>. We say that the effective union type of <code>Shape</code> is <code>{ int x, int y, ... }</code>, where <code>...</code> represents zero or more unknown fields.</p><p>Effective union types have some analogies in other programming languages. For example, in the C programming language, they are similar to the notion of a Common Initial Sequence (see e.g. <a href=http://publications.gbdirect.co.uk/c_book/chapter6/unions.html>here</a> and <a href=http://stackoverflow.com/questions/34616086/union-punning-structs-w-common-initial-sequence-why-does-c-99-but-not>here</a>). In Java, effective union types perhaps share some connection with type bounds as, for example, the type <code>T</code> where <code>T extends Shape</code> can be regarded as containing everything common to a <code>Shape</code>.</p><h3 id=readability-vs-writeability>Readability vs Writeability</h3><p>An interesting question is what we can do with an effective union.  In particular, what types we can read from it and write to it.  Let&rsquo;s consider another, slightly more interesting example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-whiley data-lang=whiley><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Message <span style=color:#069;font-weight:700>is</span> Request <span style=color:#555>|</span> Response
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Request <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> meth, URL data }
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Response <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> code, <span style=color:#078;font-weight:700>byte</span>[] data }
</span></span></code></pre></div><p>Type <code>Message</code> is an effective union which "looks" like <code>{ URL|(byte[]) data, ... }</code>. Given a variable <code>m</code> of type <code>Message</code>, reading the field <code>m.data</code> returns a value of type <code>URL|(byte[])</code>. That makes sense. So, <em>can we write to the field m.data?</em> In this case, no we can&rsquo;t.</p><p>Reading from the field of an effective union returns the union of types for that field. But, for writing, we can only write values common to all instances of that field in the union. To motivate this, let&rsquo;s refine our example a little:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-whiley data-lang=whiley><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Message <span style=color:#069;font-weight:700>is</span> Request <span style=color:#555>|</span> Response
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Request <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> meth, <span style=color:#069;font-weight:700>null</span><span style=color:#555>|</span>URL data }
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>type</span> Response <span style=color:#069;font-weight:700>is</span> { <span style=color:#078;font-weight:700>int</span> code, <span style=color:#069;font-weight:700>null</span><span style=color:#555>|</span>(<span style=color:#078;font-weight:700>byte</span>[]) data }
</span></span></code></pre></div><p>Again, suppose we have a variable <code>m</code> of type <code>Message</code>. Since <code>null</code> is supported by both instances of the data field, we can safely write <code>m.data = null</code>. But, we cannot assign a URL to <code>m.data</code> as we don&rsquo;t know whether <code>m</code> represents a <code>Request</code> or a <code>Response</code> (and if we allowed the assignment regardless, we might end up with a mangled value).</p><h3 id=conclusion>Conclusion</h3><p>Effective union types are an interesting feature of Whiley which leads to a distinction between the &ldquo;readable&rdquo; view of a type, and the &ldquo;writeable&rdquo; view. At this point in time, it&rsquo;s fair to say that it is unclear how useful this will turn out to be. But, it&rsquo;s definitely something I&rsquo;m going to continue exploring &mldr;</p><hr></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-5582165-7","auto"),ga("send","pageview"))</script></body></html>