<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Thoughts on Loop Invariants"><meta name=twitter:title content="Thoughts on Loop Invariants"><meta property="og:url" content="https://whileydave.com/2010/09/30/thoughts-on-loop-invariants/"><title>David J. Pearce
(Thoughts on Loop Invariants)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Thoughts on Loop Invariants</h1><div class=post-date>Thursday, September
30th,
2010</div><hr><p>With the recent addition of for and while loops to Whiley, I&rsquo;ve been able to fiddle around with <a href=http://wikipedia.org/wiki/loop_invariants>loop invariants</a> and already I noticed a few things.  Consider this little program:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-whiley data-lang=whiley><span style=display:flex><span><span style=color:#09f;font-style:italic>// The current parser state
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>define state as { string input, <span style=color:#078;font-weight:700>int</span> pos } <span style=color:#069;font-weight:700>where</span> pos <span style=color:#555>&gt;=</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> pos <span style=color:#555>&lt;=</span> <span style=color:#555>|</span>input<span style=color:#555>|</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>state parseWhiteSpace(state st)<span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>while</span> st.pos <span style=color:#555>&lt;</span> <span style=color:#555>|</span>input<span style=color:#555>|</span> <span style=color:#555>&amp;&amp;</span> st.input[st.pos] <span style=color:#555>==</span> <span style=color:#a00;background-color:#faa>&#39;</span> <span style=color:#a00;background-color:#faa>&#39;</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    st.pos <span style=color:#555>=</span> st.pos <span style=color:#555>+</span> <span style=color:#f60>1</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> st
</span></span></code></pre></div><p>This is a cut-down version of the function for parsing white-space in my Calculator benchmark.  Basically, it just moves the current position to the next non-space character.  The function looks OK, right?  Well, it won&rsquo;t compile because the loop invariant is wrong.</p><p>Here&rsquo;s a fixed version:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-whiley data-lang=whiley><span style=display:flex><span><span style=color:#09f;font-style:italic>// The current parser state
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>define state as { string input, <span style=color:#078;font-weight:700>int</span> pos } <span style=color:#069;font-weight:700>where</span> pos <span style=color:#555>&gt;=</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> pos <span style=color:#555>&lt;=</span> <span style=color:#555>|</span>input<span style=color:#555>|</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>state parseWhiteSpace(state st)<span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>while</span> st.pos <span style=color:#555>&gt;=</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> st.pos <span style=color:#555>&lt;</span> <span style=color:#555>|</span>input<span style=color:#555>|</span> <span style=color:#555>&amp;&amp;</span> st.input[st.pos] <span style=color:#555>==</span> <span style=color:#a00;background-color:#faa>&#39;</span> <span style=color:#a00;background-color:#faa>&#39;</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    st.pos <span style=color:#555>=</span> st.pos <span style=color:#555>+</span> <span style=color:#f60>1</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> st
</span></span></code></pre></div><p>The key is that we also need to state the position does not become negative during the loop.  This is quite fustrating really.  Hopefully, it should be easy enough for the compiler to infer simple properties like this, by looking at the loop body&mldr;</p><hr></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-5582165-7","auto"),ga("send","pageview"))</script></body></html>