<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MRLB1FVZX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MRLB1FVZX",{anonymize_ip:!1})}</script><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Parallel Sum in Whiley"><meta name=twitter:title content="Parallel Sum in Whiley"><meta property="og:url" content="https://whileydave.com/2011/08/03/parallel-sum-in-whiley/"><title>David J. Pearce
(Parallel Sum in Whiley)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css><link rel=stylesheet href=https://whileydave.com/css/syntax.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Parallel Sum in Whiley</h1><div class=post-date>Wednesday, August
3rd,
2011</div><hr><p>Recently, I&rsquo;ve been working on a variety of sequential and concurrent micro benchmarks for testing Whiley&rsquo;s performance.  An interesting and relatively simple example, is the parallel sum.  The idea is to sum a large list of integers whilst performing as much work as possible in parallel.</p><p>To implement the parallel sum, I divide the list into roughly equal sized chunks and assign one process to each:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=n>define</span> <span class=n>Sum</span> <span class=n>as</span> <span class=n>process</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=kt>int</span><span class=p>]</span> <span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>end</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>result</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Sum</span><span class=o>::</span><span class=n>start</span><span class=p>()</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sum</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>start</span><span class=p>..</span><span class=n>end</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sum</span> <span class=o>=</span> <span class=n>sum</span> <span class=o>+</span> <span class=n>items</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=p>.</span><span class=n>result</span> <span class=o>=</span> <span class=n>sum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>Sum</span><span class=o>::</span><span class=n>get</span><span class=p>()</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Sum constructor
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Sum</span> <span class=o>::</span><span class=n>Sum</span><span class=p>([</span><span class=kt>int</span><span class=p>]</span> <span class=k>is</span><span class=p>,</span> <span class=kt>int</span> <span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>e</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>spawn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span><span class=o>:</span> <span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span><span class=o>:</span> <span class=n>s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span><span class=o>:</span> <span class=n>e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>Essentially, each <code>Sum</code> process holds the original list of <code>items</code> and a range <code>start..end</code> over which to operate. The <code>result</code> is used to store the final sum until it is requested by the outer loop.  The idea is that we first construct the processes, then start them all asynchronously and, finally, collect up the results.</p><p>The outer loop looks something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=n>define</span> <span class=n>N</span> <span class=n>as</span> <span class=mi>100</span> <span class=c1>// block size to use
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=o>::</span><span class=n>parSum</span><span class=p>([</span><span class=kt>int</span><span class=p>]</span> <span class=n>items</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>|</span><span class=n>items</span><span class=o>|</span> <span class=o>!=</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Calculate how many workers required
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>nworkers</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=o>|</span><span class=n>items</span><span class=o>|</span> <span class=o>/</span> <span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=o>|</span><span class=n>items</span><span class=o>|</span> <span class=o>/</span> <span class=n>nworkers</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Construct and start workers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pos</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>workers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mi>0</span><span class=p>..</span><span class=n>nworkers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>nworkers</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>worker</span> <span class=o>=</span> <span class=n>Sum</span><span class=p>(</span><span class=n>items</span><span class=p>,</span><span class=n>pos</span><span class=p>,</span><span class=n>pos</span><span class=o>+</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Last worker picks up the slack
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>worker</span> <span class=o>=</span> <span class=n>Sum</span><span class=p>(</span><span class=n>items</span><span class=p>,</span><span class=n>pos</span><span class=p>,</span><span class=o>|</span><span class=n>items</span><span class=o>|</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Start worker asynchronously
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>worker</span><span class=o>!</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Bookkeeping
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>workers</span> <span class=o>=</span> <span class=n>workers</span> <span class=o>+</span> <span class=p>[</span><span class=n>worker</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>pos</span> <span class=o>=</span> <span class=n>pos</span> <span class=o>+</span> <span class=n>size</span>
</span></span><span class=line><span class=cl>     <span class=c1>// Collect up results
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>     <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mi>0</span> <span class=p>..</span> <span class=n>nworkers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>         <span class=n>items</span> <span class=o>=</span> <span class=n>items</span> <span class=o>+</span> <span class=p>[</span><span class=n>workers</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>get</span><span class=p>()]</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=n>items</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span></code></pre></div><p>The key here is that the outer loop continues until the original list of <code>items</code> is reduced to a single result. There maybe several iterations required, depending on the block size. Furthermore, the block size determines how many items will be processed by each process in one go. Smaller block sizes lead to more parallelism, but have higher overheads. The optimal block size probably depends on the underlying architecture, and would ideally be chosen at runtime.</p><hr></div></div></body></html>