<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Encoding C Strings in Whiley"><meta name=twitter:title content="Encoding C Strings in Whiley"><meta property="og:url" content="https://whileydave.com/2015/11/12/encoding-c-strings-in-whiley/"><title>David J. Pearce
(Encoding C Strings in Whiley)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css><link rel=stylesheet href=https://whileydave.com/css/syntax.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Encoding C Strings in Whiley</h1><div class=post-date>Thursday, November
12th,
2015</div><hr><p>In this post, we&rsquo;re going to consider representing the classic <a href=http://en.wikipedia.org/wiki/C_string_handling>C string</a> in Whiley. This turns out to be useful as we can then try to verify properties about functions which operate on C strings (e.g. <code>strlen()</code>, <code>strcpy()</code>, etc). If you&rsquo;re not familiar with C strings, then the main points are:</p><ul><li><p>Roughly speaking, C Strings are arrays of 8bit <a href=http://en.wikipedia.org/wiki/ASCII>ASCII</a> characters.</p></li><li><p>C Strings are terminated by the special character <code>'\0'</code> (also called <a href=http://en.wikipedia.org/wiki/Null-terminated_string>null terminated strings</a>).</p></li><li><p>C Strings do not carry any other length information (e.g. for the size of the containing memory chunk).</p></li></ul><p>The interesting thing about Whiley is that we can encode these constraints within the language itself using only the built-in list and integer types. Specifically, we&rsquo;re going to encode a C string as a constrained list of constrained integers. The list will be constrained to ensure it is <code>null</code> terminated, whilst the contained integers will be constrained to ensure they are between <code>0</code> and <code>255</code>.</p><p>Before giving our definition of a C string in Whiley, we need to first define the notion of an 8bit ASCII character. This is done as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=c1>// Define the ASCII 8bit character
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=n>ASCII_char</span> <span class=k>is</span> <span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=k>where</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=n>n</span> <span class=o>&lt;=</span> <span class=mi>255</span>
</span></span></code></pre></div><p>Here, we have defined an 8bit ASCII character to be an integer which is constrained between <code>0</code> and <code>255</code> (i.e. to ensure it fits in 8 bits). Using this, we can now define our notion of a <code>C</code> string as follows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=c1>// Define the null terminator
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>constant</span> <span class=n>NULL</span> <span class=k>is</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=n>C_string</span> <span class=k>is</span> <span class=p>(</span><span class=n>ASCII_char</span><span class=p>[]</span> <span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// Must have at least one character (i.e. null terminator)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>where</span> <span class=o>|</span><span class=n>str</span><span class=o>|</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=k>some</span> <span class=p>{</span> <span class=n>i</span> <span class=k>in</span> <span class=mi>0</span> <span class=p>..</span> <span class=o>|</span><span class=n>str</span><span class=o>|</span> <span class=o>|</span> <span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>NULL</span> <span class=p>}</span>
</span></span></code></pre></div><p>Here, we have then defined a <code>C_String</code> to be a list of integers which is constrained to ensure it is always null terminated. That is, there is always at least one NULL terminator somewhere in the array (though there may be several).</p><p>As an example to illustrate the use of our <code>C_string</code>, we provide an implementation of the well-known <code>strlen()</code> function below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=c1>// Determine the length of a C string.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=n>strlen</span><span class=p>(</span><span class=n>C_string</span> <span class=n>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=kt>int</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>str</span><span class=p>[</span><span class=n>r</span><span class=p>]</span> <span class=o>==</span> <span class=n>NULL</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=k>all</span> <span class=p>{</span> <span class=n>k</span> <span class=k>in</span> <span class=mi>0</span> <span class=p>..</span> <span class=n>r</span> <span class=o>|</span> <span class=n>str</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>!=</span> <span class=n>NULL</span> <span class=p>}</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>NULL</span>
</span></span><span class=line><span class=cl>  <span class=k>where</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=o>|</span><span class=n>str</span><span class=o>|</span>
</span></span><span class=line><span class=cl>  <span class=k>where</span> <span class=k>all</span> <span class=p>{</span> <span class=n>k</span> <span class=k>in</span> <span class=mi>0</span> <span class=p>..</span> <span class=n>i</span> <span class=o>|</span> <span class=n>str</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>!=</span> <span class=n>NULL</span><span class=p>}</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>i</span>
</span></span></code></pre></div><p>The Whiley compiler statically verifies this function does not overrun the string bounds. The loop invariant given by the <code>where</code> clause is needed as a hint to the verifier, but does not affect the function&rsquo;s execution in any way.</p><hr></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-5582165-7","auto"),ga("send","pageview"))</script></body></html>