<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Writing a PNG Decoder in Whiley!"><meta name=twitter:title content="Writing a PNG Decoder in Whiley!"><meta property="og:url" content="https://whileydave.com/2012/02/18/writing-a-png-decoder-in-whiley/"><title>David J. Pearce
(Writing a PNG Decoder in Whiley!)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css><link rel=stylesheet href=https://whileydave.com/css/syntax.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Writing a PNG Decoder in Whiley!</h1><div class=post-date>Saturday, February
18th,
2012</div><hr><p>Over the last few days, I have been writing GIF and PNG decoders in Whiley.  These form part of an image manipulation benchmark which I&rsquo;m planning to use for experimenting with the compiler.  The PNG decoder, in particular, was rather interesting.  My implementation is based directly off the <a href=http://www.w3.org/TR/2003/REC-PNG-20031110/>PNG Specification,</a> <a href=http://www.w3.org/TR/2003/REC-PNG-20031110/>ISO/IEC 15948:2003 (E)</a>. The PNG format uses the <a href=http://en.wikipedia.org/wiki/DEFLATE>DEFLATE algorithm</a> for decompression (as used by e.g. GZip).  This was convenient since I&rsquo;d already implemented DEFLATE in Whiley!</p><p>You can find the complete code for my PNG decoder <a href=https://github.com/DavePearce/wybench/tree/master/sequential/convert/imagelib/png>here</a>.  To compile it, you&rsquo;ll probably need to checkout the latest <a href=https://github.com/DavePearce/Whiley/tree/devel>development snapshot of the Whiley compiler</a>.  At the moment, it doesn&rsquo;t run too fast either &mldr; but that&rsquo;s mostly because arithmetic in Whiley is unbounded and, hence, relatively slow. Eventually, I will optimise most of this overhead away.</p><h2 id=filtering>Filtering</h2><p>The PNG format is interesting because it employs filtering at the scanline level.  This means it applies one of five possible functions to each scanline in order to increase the amount of order and, hence, improve the compression ratio.  For some reason, I got particularly stuck debugging this part.  The bugs, however, produced some interesting effects:</p><div class=showcase><figure class=text-center><img width=100% src=/images/2012/medium-grayscale.png></figure><figure class=text-center><img width=100% src=/images/2012/img-nofiltering.png></figure><figure class=text-center><img width=100% src=/images/2012/img-second-bug.png></figure></div><p>On the left, we see the original image. In the middle, we see the image produced by my decoder without filtering being applied. On the right, we see the image produced by my decoder with a bug in the <a href=http://en.wikipedia.org/wiki/Portable_Network_Graphics#Filtering>Paeth Predictor</a> filtering function.  The filters are based around adding the value of a previous pixel (e.g. to the left or above) to the current pixel.  As you can see on the right, one mistake early on in a scanline is then propagated along the scanline producing a variety of different effects!</p><h2 id=constraints>Constraints</h2><p>Another interesting aspect of the PNG format are the constraints imposed on its data values.  The following excerpt from the spec defines constraints on the PNG header:</p><blockquote><p>The IHDR chunk shall be the first chunk in the PNG datastream. It contains:
omitted tag &ldquo;table&rdquo;
Width and height give the image dimensions in pixels. They are PNG four-byte unsigned integers. Zero is an invalid value.</p><p>Bit depth is a single-byte integer giving the number of bits per sample or per palette index (not per pixel). Valid values are 1, 2, 4, 8, and 16, although not all values are allowed for all colour types. See 6.1: Colour types and values.</p><p>Colour type is a single-byte integer that defines the PNG image type. Valid values are 0, 2, 3, 4, and 6.</p><p>Bit depth restrictions for each colour type are imposed to simplify implementations and to prohibit combinations that do not compress well.</p></blockquote><p>These constraints are particularly interesting because, in Whiley, <em>I can represent them directly in the code</em>.  The following illustrates the PNG header abstraction:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=k>public</span> <span class=n>define</span> <span class=n>ValidColorDepths</span> <span class=n>as</span> <span class=p>[</span>
</span></span><span class=line><span class=cl> <span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>8</span><span class=p>,</span><span class=mi>16</span><span class=p>},</span> <span class=c1>// GREYSCALE
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>{},</span>           <span class=c1>// (empty)
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>{</span><span class=mi>8</span><span class=p>,</span><span class=mi>16</span><span class=p>},</span>       <span class=c1>// TRUECOLOR
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>define</span> <span class=n>IHDR</span> <span class=n>as</span> <span class=p>{</span> <span class=c1>// Image Header
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>u32</span> <span class=n>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>u32</span> <span class=n>height</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BitDepth</span> <span class=n>bitDepth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>ColorType</span> <span class=n>colorType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>where</span> <span class=n>width</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>height</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>bitDepth</span> <span class=k>in</span> <span class=n>ValidColorDepths</span><span class=p>[</span><span class=n>colorType</span><span class=p>]</span>
</span></span></code></pre></div><p>Here, we can see the constraints on the <code>width</code>, <code>height</code> and <code>bitdepth</code> are encoded directly into the program. Currently, violation of these constraints results in a runtime assertion failure. In the future, the aim is to check them at compile time.</p><h2 id=conclusion>Conclusion</h2><p>It&rsquo;s been fun learning about the PNG and GIF file formats.  And, of course, writing realistic benchmarks provides extremely helpful feedback on the language design.  All up, I&rsquo;m very pleased to see that writing programs in Whiley was an enjoyable experience!  There&rsquo;s a long way to go yet though, as writing these benchmarks has uncovered a bunch of compiler bugs for me to work on over the coming weeks and months &mldr;</p><hr></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-5582165-7","auto"),ga("send","pageview"))</script></body></html>