<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="Proving a Beautiful Identity in Dafny"><meta name=twitter:title content="Proving a Beautiful Identity in Dafny"><meta property="og:description" content="Using Dafny we can prove a beautiful mathematical identity with releative ease."><meta name=twitter:description content="Using Dafny we can prove a beautiful mathematical identity with releative ease."><meta property="og:url" content="https://whileydave.com/2023/07/17/proving-a-beautiful-identity-in-dafny/"><title>David J. Pearce
(Proving a Beautiful Identity in Dafny)</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whileydave.com/css/page.css><link rel=stylesheet href=https://whileydave.com/css/menu.css><link rel=stylesheet href=https://whileydave.com/css/style.css><link rel=stylesheet href=https://whileydave.com/css/syntax.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><header class=topbar><div class=topbar-header onclick=clearMenu()><div class=topbar-title>Dr. David J. Pearce</div><div class=topbar-subtitle></div></div><div class=topbar-social onclick=clearMenu()><a href=https://github.com/DavePearce><i class="fa fa-github" aria-hidden=true></i></a>
<a href=https://twitter.com/WhileyDave><i class="fa fa-twitter" aria-hidden=true></i></a>
<a href=https://www.youtube.com/user/redjamjar/><i class="fa fa-youtube-play" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/david-pearce-8592647/><i class="fa fa-linkedin-square" aria-hidden=true></i></a></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whileydave.com/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whileydave.com/blog/>Blog</a>
<a href=https://whileydave.com/projects/>Projects</a>
<a href=https://whileydave.com/publications/>Publications</a>
<a href=https://whileydave.com/talks/>Talks</a>
<a href=https://whileydave.com/>Home</a></div></div></div></header><div class=container onclick=clearMenu()><div class=content><h1 class=post-title>Proving a Beautiful Identity in Dafny</h1><div class=post-date>Monday, July
17th,
2023</div><hr><p>Recently, I came across <a href="https://twitter.com/Mathinity_/status/1679451151517859841?s=20">a tweet</a>
about the following identity:</p><figure class=text-center><img width=454px alt="Illustrating a mathematical identity which relates the square of the sum from 1 to n with the sum from 1 to n of cubes." src=/images/2023/DafnyIdentity_eg1.png></figure><p>This seemed quite surprising to me, though the tweet&rsquo;s thread included
a number of proofs. We can check the first few values easily for
ourself:</p><figure class=text-center><img width=454px alt="Illustrating the first three evaluations of the mathematical identity at x=1, x=2 and x=3." src=/images/2023/DafnyIdentity_eg2.png></figure><p>So, the thought occurred: <em>can we prove this identity with Dafny?</em></p><h2 id=setup>Setup</h2><p>Before we can prove the identity we need to first translate it into
Dafny. This is actually pretty straightforward, and we can translate
the left-hand side of our identity as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=kd>function</span> <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> <span class=o>:</span> <span class=n>nat</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=n>then</span> <span class=mi>1</span> 
</span></span><span class=line><span class=cl>  <span class=k>else</span> 
</span></span><span class=line><span class=cl>     <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This describes the sum of cubes using a recursive function, which
works out well. For the right-hand side, we&rsquo;ll use the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=kd>function</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> <span class=o>:</span> <span class=n>nat</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=n>then</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> 
</span></span><span class=line><span class=cl>    <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This describes the sum from <code>1</code> to <code>n</code>, which can then be squared. We
can now express the identity as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=n>lemma</span> <span class=n>Identity</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> 
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>*</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, the precondition <code>n > 0</code> is required for both <code>Sum(n)</code> and
<code>Sum3(n)</code> to make sense. Furthermore, the <code>...</code> is where our proof
goes (more on this below).</p><h2 id=proof>Proof</h2><p>At this point, I&rsquo;ll jump right in and show the Dafny proof:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=n>lemma</span> <span class=n>Identity</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> 
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>*</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>n</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=n>m</span> <span class=o>:=</span> <span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=p>}</span>
</span></span></code></pre></div><p>This proof probably seems quite strange (certainly, it does to me) so
let&rsquo;s unpack it. First, it&rsquo;s worth noting that I did not just write
this out first time and get it. In fact, I spent several hours
playing around with various intermediate forms before finally arriving
at what we have above. Specifically, it took me a while to realise
<code>Sum(n)*Sum(n) == Sum(m)*Sum(m) + n*n*n</code> which was key (I actually
didn&rsquo;t look at the existing proofs beforehand, so I was starting out
from scratch).</p><p>Anyway, hopefully it is reasonably clear that, if both assertions
above hold, then the final identity holds. So the proof really breaks
down into two parts, one for each assertion.</p><h3 id=first-assertion>First Assertion</h3><p>The first assertion claims the following holds (where <code>m==n-1</code> as above):</p><pre tabindex=0><code>Sum(n)*Sum(n) == Sum(m)*Sum(m) + n*n*n
</code></pre><p>We can actually see this holds reasonably easily for ourselves.
First, start out with the equivalence:</p><pre tabindex=0><code>Sum(n)*Sum(n) == Sum(n)*Sum(n) 
</code></pre><p>Then, unroll <code>Sum()</code> once on the right-hand side to get:</p><pre tabindex=0><code>Sum(n)*Sum(n) == (Sum(m)+n)*(Sum(m)+n)
</code></pre><p>Next, multiply out the right-hand side to give:</p><pre tabindex=0><code>Sum(n)*Sum(n) == Sum(m)*Sum(m) + 2*n*Sum(m) + n*n
</code></pre><p>Finally, apply the <a href=https://en.wikipedia.org/wiki/1_%2B_2_%2B_3_%2B_4_%2B_%E2%8B%AF>well-known
equivalence</a>
to get <code>Sum(m) = m*(m+1)/2</code>. Since <code>m==n-1</code>, this is actually <code>Sum(m) == m*n / 2</code>. Now, substituting this into the middle term of our
equation and simplify:</p><pre tabindex=0><code>Sum(n)*Sum(n) == Sum(m)*Sum(m) + n*n*n
</code></pre><p>And, at this point, we&rsquo;re done! What&rsquo;s impressive is that Dafny
appears to do all of this for us (more on this later).</p><h3 id=second-assertion>Second Assertion</h3><p>The second assertion claims the following holds:</p><pre tabindex=0><code>Sum3(n) == Sum(m)*Sum(m) + n*n*n
</code></pre><p>This is relatively easy to arrive at by induction. When <code>n > 0</code> then
<code>Sum(m)*Sum(m) == Sum3(m)</code> by induction. Thus, start out with:</p><pre tabindex=0><code>Sum3(n) == Sum3(n)
</code></pre><p>Then, unrolling <code>Sum3(n)</code> on the right-hand side gives:</p><pre tabindex=0><code>Sum3(n) == Sum3(m) + n*n*n
</code></pre><p>And, at this point, apply the inductive hypothesis:</p><pre tabindex=0><code>Sum3(n) == Sum(m)*Sum(m) + n*n*n
</code></pre><p>Finally, its worth noting that Dafny automatically applies induction
for us (when it can). Hence, it was able to show this second
assertion without further help.</p><h3 id=manual-induction>Manual Induction</h3><p>The original Dafny proof above relies heavily on Dafny&rsquo;s automatic
induction. So, I thought it would be interesting to develop a proof
without relying on this. This is what I ended up with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=n>lemma</span> <span class=p>{</span><span class=o>:</span><span class=n>induction</span> <span class=kc>false</span><span class=p>}</span> <span class=n>Identity</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> 
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>*</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=n>Sum3</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>n</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>var</span> <span class=n>m</span> <span class=o>:=</span> <span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Identiy</span><span class=p>(</span><span class=n>m</span><span class=p>);</span> <span class=c1>// apply induction
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>calc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>==</span>
</span></span><span class=line><span class=cl>      <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>==</span> <span class=p>{</span> <span class=n>Sum1toN</span><span class=p>(</span><span class=n>m</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=p>((</span><span class=n>n</span><span class=o>*</span><span class=n>m</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>==</span> <span class=p>{</span> <span class=n>NNm1Mod2</span><span class=p>(</span><span class=n>n</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>==</span> 
</span></span><span class=line><span class=cl>      <span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>*</span><span class=n>Sum</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=o>*</span><span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=p>}</span> <span class=p>}</span>
</span></span></code></pre></div><p>Here, <code>{:induction false}</code> turns off Dafny&rsquo;s automatic induction.
Also, Dafny&rsquo;s <code>calc</code> statement walks us through the intermediate steps
required to establish the first assertion above. The curious thing,
however, is that I needed the following intermediate lemmas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Whiley data-lang=Whiley><span class=line><span class=cl><span class=n>lemma</span> <span class=n>Sum1toN</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span> 
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>n</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>==</span> <span class=n>Sum</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lemma</span> <span class=n>NNm1Mod2</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>n</span><span class=o>%</span><span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=n>Mod2</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Mod2</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>((</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>n</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lemma</span> <span class=n>Mod2</span><span class=p>(</span><span class=n>n</span><span class=o>:</span><span class=n>nat</span><span class=p>,</span><span class=n>m</span><span class=o>:</span><span class=n>nat</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>requires</span> <span class=n>n</span><span class=o>%</span><span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=n>m</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>m</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>{</span> <span class=n>Mod2</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>m</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is curious because I&rsquo;m unclear how Dafny proved the original
version of the proof without these Lemma&rsquo;s. Its possible there is an
easier proof via manual induction which I didn&rsquo;t find 🤷‍♂.</p><h2 id=conclusion>Conclusion</h2><p>If you&rsquo;ve made it this far, then well done! In the end, it was a fair
amount of work to prove the original identity in Dafny. Still, I find
it pretty amazing that I could prove it from scratch without too much
trouble.</p><hr></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MRLB1FVZX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MRLB1FVZX",{anonymize_ip:!1})}</script></body></html>